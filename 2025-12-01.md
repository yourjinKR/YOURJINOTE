
## N+1 문제
```java
@Query("SELECT DISTINCT e " +  
        "FROM Exercise e " +  
        "LEFT JOIN FETCH e.targets t " +  
        "LEFT JOIN FETCH t.bodyDetailPart bd " +  
        "LEFT JOIN FETCH bd.bodyPart bp " +  
        "LEFT JOIN FETCH e.effects " +  
        "WHERE e.id = :id")  
Optional<Exercise> findByIdWithDetails(@Param("id") Long id);
```

#### 기존 결과
```
2025-12-01T02:01:54.877+09:00  INFO 18964 --- [backend] [nio-8080-exec-3] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'
2025-12-01T02:01:54.877+09:00  INFO 18964 --- [backend] [nio-8080-exec-3] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
2025-12-01T02:01:54.879+09:00  INFO 18964 --- [backend] [nio-8080-exec-3] o.s.web.servlet.DispatcherServlet        : Completed initialization in 2 ms
[Hibernate] 
    select
        e1_0.id,
        e1_0.category,
        e1_0.created_at,
        e1_0.deleted_at,
        e1_0.description,
        e1_0.details,
        e1_0.hidden,
        e1_0.name,
        e1_0.updated_at 
    from
        exercises e1_0 
    where
        e1_0.id=?
[Hibernate] 
    select
        t1_0.exercise_id,
        t1_0.id,
        t1_0.body_detail_part_id,
        t1_0.target_role 
    from
        exercise_targets t1_0 
    where
        t1_0.exercise_id=?
[Hibernate] 
    select
        bdp1_0.id,
        bdp1_0.body_part_id,
        bdp1_0.name 
    from
        body_detail_parts bdp1_0 
    where
        bdp1_0.id in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
[Hibernate] 
    select
        bp1_0.id,
        bp1_0.name 
    from
        body_parts bp1_0 
    where
        bp1_0.id=?
[Hibernate] 
    select
        e1_0.exercise_id,
        e1_0.effect_type 
    from
        exercise_effects e1_0 
    where
        e1_0.exercise_id=?

```
#### 수정 후
```
[Hibernate] 
    select
        distinct e1_0.id,
        e1_0.category,
        e1_0.created_at,
        e1_0.deleted_at,
        e1_0.description,
        e1_0.details,
        e2_0.exercise_id,
        e2_0.effect_type,
        e1_0.hidden,
        e1_0.name,
        t1_0.exercise_id,
        t1_0.id,
        t1_0.body_detail_part_id,
        bdp1_0.id,
        bdp1_0.body_part_id,
        bp1_0.id,
        bp1_0.name,
        bdp1_0.name,
        t1_0.target_role,
        e1_0.updated_at 
    from
        exercises e1_0 
    left join
        exercise_targets t1_0 
            on e1_0.id=t1_0.exercise_id 
    left join
        body_detail_parts bdp1_0 
            on bdp1_0.id=t1_0.body_detail_part_id 
    left join
        body_parts bp1_0 
            on bp1_0.id=bdp1_0.body_part_id 
    left join
        exercise_effects e2_0 
            on e1_0.id=e2_0.exercise_id 
    where
        e1_0.id=?
```


## 가변인자 이슈

```java
@Getter  
@RequiredArgsConstructor  
public enum ExerciseErrorCode implements ErrorCode {  
    NOT_FOUND(HttpStatus.NOT_FOUND, "해당 ID와 일치하는 운동 정보를 찾지 못했습니다 ID : {0}"),  
    BODY_DETAIL_NOT_FOUND(HttpStatus.NOT_FOUND, "해당 ID와 일치하는 세부 부위를 찾지 못했습니다 ID : {0}"),  
    ;  
  
    private final HttpStatus httpStatus;  
    private final String message;  
  
  
    @Override  
    public String format(Object... args) {  
        return MessageFormat.format(message, args);  
    }  
}
```
에러 메세지에 세부 정보를 담고 싶음.
id와 같은 정보를 받아 에러 메세지에 포맷팅 하도록.
그렇기에 가변 인자로 설계함 -> 에러 메세지에 몇개의 부가 정보가 필요할지 모르니

```
{
    "code": "NOT_FOUND",
    "message": "해당 ID와 일치하는 운동 정보를 찾지 못했습니다 ID : [Ljava.lang.Object;@1a36b45c"
}
```
그러나 예상과는 달리 이와 같이 출력


```java
public class Main {  
    public void fun(String ...strings) {  
          
    }  
  
    static public String format(String message, Object ...args) {  
        System.out.println(Arrays.toString(args));  
        return MessageFormat.format(message, args);  
    }  
  
    public static void main(String[] args) {  
        long id = 1;  
        String message = "해당 ID와 일치하는 세부 부위를 찾지 못했습니다 ID : {0}";  
  
        System.out.println(format(message, id, 2, 3, 4));  
    }  
}
```
테스트 해봤으나 정상적임

![[Pasted image 20251201210207.png]]

### 문제점 : 의도치 않는 형변환과 Wrapping 중복복
```java
@ExceptionHandler(RestApiException.class)  
public ResponseEntity<Object> handleCustomException(RestApiException e) {  
    ErrorCode errorCode = e.getErrorCode();  
    Object args = e.getArgs();  
  
    if (args == null)  
        return handleExceptionInternal(errorCode);  
  
    else  
        return handleExceptionInternal(errorCode, args);  
}
```
문제점은 `Object[]` 타입을 `Objcet`로 강제 형 변환함.
그 이후 다음 메서드에서 매개변수를 가변 인수로 요구하기에 한번 더 배열로 Wrapping함.
```java
private ResponseEntity<Object> handleExceptionInternal(ErrorCode errorCode, Object ...args) {  
    return ResponseEntity.status(errorCode.getHttpStatus())  
            .body(makeErrorResponse(errorCode, args));  
}
```

![[Pasted image 20251201210258.png]]