


# ADT Map

- key-value pair을 저장하는 추상 자료형
- 같은 key를 가진 pair는 최대 한 개만 존재
- associative array, dictionary라고도 부른다

## Map 구현체

- Hash Table
- Tree-based

### Hash Table

- 배열과 해시 함수를 사용하여 Map을 구현한 자료 구조
- 상수 시간으로 데이터에 접근


# ADT Set

- 데이터를 저장하는 추상 자료형
- 순서를 보장하지 않음
- 데이터 중복을 허용하지 않음
- 데이터 조회가 List보다 빠름

## 사용 시기

- 중복된 데이터를 제거할 때
- 데이터의 존재 여부를 확인할 때

## HashSet




# Java Set

- 순서 X, 중복 X

- HashSet : 대용량 데이터 저장/탐색에 유리
- TreeSet : 범위 탐색과 정렬에 유리

`add()`할때마다 중복을 검사하기에 반환 타입은 boolean이다.

> 이때 `equals()`와 `hashCode()`를 호출하기에 오버라이딩에 주의하자






---

운동루틴 수정 DTO를 보내줄테니 postman에서 테스트할 수 있도록 json 예시 만들어줘.
루틴정보 상세보기 json 응답 결과 또한 추가하였으니 참고해서.
운동의 id는 8~21까지 있음.

```java
package app.fitsync.domain.routine.dto.routine;

import app.fitsync.domain.routine.dto.exercise.RoutineExerciseDeleteRequest;
import app.fitsync.domain.routine.dto.exercise.RoutineExerciseRequest;
import app.fitsync.domain.routine.dto.exercise.RoutineExerciseUpdateRequest;
import jakarta.annotation.Nullable;
import jakarta.validation.Valid;
import jakarta.validation.constraints.NotNull;
import java.util.List;

public record RoutineUpdateRequest(

        @NotNull
        String name,

        @NotNull
        int displayOrder,

        @NotNull
        String description,

        @Nullable
        @Valid
        List<RoutineExerciseRequest> newExercises,

        @Nullable
        @Valid
        List<RoutineExerciseUpdateRequest> updateExercises,

        @Nullable
        @Valid
        List<RoutineExerciseDeleteRequest> deleteExercises
) {
}

```

```java
package app.fitsync.domain.routine.dto.exercise;

import app.fitsync.domain.routine.dto.set.RoutineSetRequest;
import app.fitsync.domain.routine.entity.RoutineExercise;
import jakarta.validation.Valid;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Size;
import java.util.List;

public record RoutineExerciseRequest(

        @NotNull
        long exerciseId,

        @NotNull
        int displayOrder,

        @NotNull
        @Size(max = RoutineExercise.DESCRIPTION_MAX_LENGTH)
        String description,

        @NotNull
        @Valid
        List<RoutineSetRequest> routineSets
) {
}

```

```java
package app.fitsync.domain.routine.dto.exercise;  
  
import app.fitsync.domain.routine.dto.set.RoutineSetDeleteRequest;  
import app.fitsync.domain.routine.dto.set.RoutineSetRequest;  
import app.fitsync.domain.routine.dto.set.RoutineSetUpdateRequest;  
import app.fitsync.domain.routine.entity.RoutineExercise;  
import jakarta.annotation.Nullable;  
import jakarta.validation.Valid;  
import jakarta.validation.constraints.NotNull;  
import jakarta.validation.constraints.Size;  
import java.util.List;  
  
public record RoutineExerciseUpdateRequest(  
  
        @NotNull  
        long id,  
  
        @NotNull  
        int displayOrder,  
  
        @NotNull  
        @Size(max = RoutineExercise.DESCRIPTION_MAX_LENGTH)  
        String description,  
  
        @Nullable  
        @Valid        List<RoutineSetRequest> newRoutineSets,  
  
        @Nullable  
        @Valid        List<RoutineSetUpdateRequest> updateRoutineSets,  
  
        @Nullable  
        @Valid        List<RoutineSetDeleteRequest> deleteRoutineSets  
) {  
}
```


```java
package app.fitsync.domain.routine.dto.exercise;  
  
import jakarta.validation.constraints.NotNull;  
  
public record RoutineExerciseDeleteRequest(  
  
        @NotNull  
        long id  
) {  
}
```

```java
package app.fitsync.domain.routine.dto.set;  
  
  
import jakarta.validation.constraints.NotNull;  
  
public record RoutineSetRequest(  
  
        @NotNull  
        int displayOrder,  
  
        Integer weightKg,  
        Integer reps,  
        Integer distanceM,  
        Integer durationSec,  
        Integer speedKmh,  
        Integer rpe,  
        Integer restTimeSec  
) {  
}
```

```java
package app.fitsync.domain.routine.dto.set;  
  
import jakarta.validation.constraints.NotNull;  
  
public record RoutineSetUpdateRequest(  
  
        @NotNull  
        long id,  
  
        @NotNull  
        int displayOrder,  
  
        Integer weightKg,  
        Integer reps,  
        Integer distanceM,  
        Integer durationSec,  
        Integer speedKmh,  
        Integer rpe,  
        Integer restTimeSec  
) {  
}
```

```java
package app.fitsync.domain.routine.dto.set;  
  
import jakarta.validation.constraints.NotNull;  
  
public record RoutineSetDeleteRequest(  
        @NotNull  
        long id  
) {  
}
```

```json
{
    "id": 7,
    "name": "3분할 상체 비대칭 교정 루틴",
    "displayOrder": 1,
    "description": "라운드 숄더 교정과 등 근육 활성화를 위한 메인 루틴입니다.",
    "routineExercises": [
        {
            "id": 12,
            "exerciseId": 10,
            "exerciseName": "가슴을 쓰는 요가 운돋임",
            "displayOrder": 1,
            "description": "등 운동: 견갑골 움직임에 집중하세요.",
            "routineSets": [
                {
                    "id": 16,
                    "displayOrder": 1,
                    "weightKg": 20,
                    "reps": 15,
                    "distanceM": null,
                    "durationSec": null,
                    "speedKmh": null,
                    "rpe": 6,
                    "restTimeSec": 60
                },
                {
                    "id": 17,
                    "displayOrder": 2,
                    "weightKg": 40,
                    "reps": 12,
                    "distanceM": null,
                    "durationSec": null,
                    "speedKmh": null,
                    "rpe": 7,
                    "restTimeSec": 90
                }
            ]
        },
        {
            "id": 13,
            "exerciseId": 11,
            "exerciseName": "가슴을 쓰는 요가 운돋임",
            "displayOrder": 2,
            "description": "유산소 마무리: 인터벌 러닝",
            "routineSets": [
                {
                    "id": 18,
                    "displayOrder": 1,
                    "weightKg": null,
                    "reps": null,
                    "distanceM": 1500,
                    "durationSec": 600,
                    "speedKmh": 10,
                    "rpe": 8,
                    "restTimeSec": 120
                }
            ]
        }
    ]
}
```



---

```json

{
  "name": "3분할 상체 비대칭 교정 루틴 (Ver.2)",
  "displayOrder": 1,
  "description": "기존 루틴에서 유산소를 빼고 코어 운동을 추가했으며, 등 운동 중량을 늘렸습니다.",
  
  // 1. [운동 추가] 새로운 운동 추가 (Exercise ID 20 사용)
  "newExercises": [
    {
      "exerciseId": 20,
      "displayOrder": 2,
      "description": "마무리 코어 운동: 플랭크 및 크런치",
      "routineSets": [
        {
          "displayOrder": 1,
          "time": 60,
          "rpe": 8,
          "restTimeSec": 30
          // weightKg, reps 등은 null이므로 생략
        },
        {
          "displayOrder": 2,
          "time": 45,
          "rpe": 9,
          "restTimeSec": 30
        }
      ]
    }
  ],

  // 2. [운동 수정] 기존 운동(ID 12)의 정보 및 세트 변경
  "updateExercises": [
    {
      "id": 12, 
      "displayOrder": 1,
      "description": "등 운동: 견갑골 하강 집중 (중량 증량함)",
      
      // 2-1. [세트 추가] 3세트 새로 추가
      "newRoutineSets": [
        {
          "displayOrder": 3,
          "weightKg": 30,
          "reps": 10,
          "rpe": 9,
          "restTimeSec": 60
        }
      ],

      // 2-2. [세트 수정] 1세트(ID 16) 무게 수정 (20kg -> 25kg)
      "updateRoutineSets": [
        {
          "id": 16,
          "displayOrder": 1,
          "weightKg": 25,
          "reps": 15,
          "rpe": 7,
          "restTimeSec": 60
        }
      ],

      // 2-3. [세트 삭제] 2세트(ID 17) 삭제
      "deleteRoutineSets": [
        {
          "id": 17
        }
      ]
    }
  ],

  // 3. [운동 삭제] 기존 운동(ID 13 - 유산소) 삭제
  "deleteExercises": [
    {
      "id": 13
    }
  ]
}
```

![[Pasted image 20251222135656.png]]

![[Pasted image 20251222142707.png]]


```java
{
    "name": "3분할 상체 비대칭 교정 루틴 (Ver.3)",
    "displayOrder": 1,
    "description": "기존 루틴에서 유산소를 빼고 코어 운동을 추가했으며, 등 운동 중량을 늘렸습니다.",
    "newExercise": [],
    "updateExercises": [
        {
            "id": 13,
            "displayOrder": 2,
            "description": "설명을 바꿨음",
            "newRoutineSets" : [
                {
                    "displayOrder": 3,
                    "weightKg": 30,
                    "reps": 10,
                    "rpe": 9,
                    "restTimeSec": 60
                },
                {
                    "displayOrder": 3,
                    "weightKg": 30,
                    "reps": 10,
                    "rpe": 9,
                    "restTimeSec": 60
                }
            ],
            "deleteRoutineSets" : [
                { "id" : 30 }
            ]
        }
    ]
}
```

![[Pasted image 20251222142820.png]]

```java
{
    "name": "3분할 상체 비대칭 교정 루틴 (Ver.3)",
    "displayOrder": 1,
    "description": "기존 루틴에서 유산소를 빼고 코어 운동을 추가했으며, 등 운동 중량을 늘렸습니다.",
    "newExercise": [],
    "updateExercises": [
        {
            "id": 13,
            "displayOrder": 2,
            "description": "설명을 바꿨음",
            "newRoutineSets" : [
                {
                    "displayOrder": 3,
                    "weightKg": 30,
                    "reps": 10,
                    "rpe": 9,
                    "restTimeSec": 60
                },
                {
                    "displayOrder": 3,
                    "weightKg": 30,
                    "reps": 10,
                    "rpe": 9,
                    "restTimeSec": 60
                }
            ],
            "deleteRoutineSets" : [
                { "id" : 28 },
                { "id" : 29 },
                { "id" : 31 }
            ]
        }
    ]
}
```


---

# PR

## 작업내용
- [ ] 루틴 수정 API 구현
- [ ] 하위 엔티티 처리 순서 디버깅
- [ ] 엣지 케이스 고려한 예외처리 추가

### 하위 엔티티 처리 순서 디버깅
수정 API를 구현함에 있어 다양한 방식 중 (`덮어쓰기 or  부분 수정`) 부분 수정을 선택했다.
최상위 엔티티를 수정하는 작업에서는 하위 엔티티가 생성, 수정, 삭제되는 작업이 동반되도록 했다.
그렇기에 아래와 같이 DTO를 구분하였다.
```java
public record RoutineUpdateRequest(
       // 생략...
        @Nullable
        @Valid
        List<RoutineExerciseRequest> newExercises,

        @Nullable
        @Valid
        List<RoutineExerciseUpdateRequest> updateExercises,

        @Nullable
        @Valid
        List<RoutineExerciseDeleteRequest> deleteExercises
) {
}
```

그 과정에서 생성 작업을 먼저 수행 후 하위 엔티티에 대해 id를 조회했고, 그 과정에서 NPE가 발생했다.
```java
public void deleteRoutineSet(long routineSetId) {
    boolean removeIf = routineSets.removeIf(routineSet -> routineSet.getId().equals(routineSetId));
    if (!removeIf) {
        throw new RestApiException(RoutineErrorCode.SET_NOT_FOUND, routineSetId);
    }
}
```

작업 순서를 아래와 같이 변경했고 이를 해결했다.
```
생성 -> 수정 -> 삭제
삭제 -> 수정 -> 생성
```